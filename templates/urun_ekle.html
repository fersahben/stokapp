{% extends "base.html" %}

{% block title %}Yeni Ürün{% endblock %}

{% block extra_css %}
<style>
    #video-preview {
        width: 100%;
        max-width: 500px;
        height: 300px;
        background-color: #000;
        margin: 1rem auto;
        display: none;
        border-radius: 8px;
    }
    .preview-image {
        max-width: 200px;
        max-height: 200px;
        object-fit: cover;
        margin-top: 1rem;
        border-radius: 8px;
    }
    
    /* Mobil cihazlar için özel stiller */
    @media (max-width: 768px) {
        .card {
            border-radius: 8px;
            margin: 0.5rem;
        }
        
        .card-body {
            padding: 1rem;
        }
        
        .form-label {
            font-size: 0.9rem;
            margin-bottom: 0.3rem;
        }
        
        .form-control {
            font-size: 1rem;
            padding: 0.4rem 0.6rem;
        }
        
        .btn {
            width: 100%;
            margin-bottom: 0.5rem;
        }
        
        .text-muted {
            font-size: 0.8rem;
        }
        
        #video-preview {
            height: 250px;
        }
        
        .preview-image {
            max-width: 150px;
            max-height: 150px;
        }
    }
    
    /* Tablet cihazlar için özel stiller */
    @media (min-width: 769px) and (max-width: 991px) {
        .card {
            margin: 1rem;
        }
        
        .btn {
            padding: 0.4rem 0.8rem;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                <h3 class="card-title mb-0">Yeni Ürün Ekle</h3>
            </div>
            <div class="card-body">
                <form method="post" enctype="multipart/form-data" id="urun-form">
                    <div class="row mb-3">
                        <div class="col-md-9">
                            <label for="barkod" class="form-label">Barkod</label>
                            <input type="text" class="form-control" id="barkod" name="barkod" pattern="\d*" minlength="12" maxlength="12" value="{{ request.args.get('barkod', '') }}">
                            <small class="text-muted">12 haneli barkod numarası girin veya boş bırakın. Boş bırakırsanız otomatik oluşturulacaktır.</small>
                        </div>
                        <div class="col-md-3 d-flex align-items-end">
                            <button type="button" class="btn btn-primary w-100" id="barkod-tara">
                                <i class="fas fa-barcode me-1"></i>Barkod Tara
                            </button>
                        </div>
                    </div>

                    <div id="kamera-alani">
                        <video id="video-preview"></video>
                    </div>

                    <div class="mb-3">
                        <label for="ad" class="form-label">Ürün Adı</label>
                        <input type="text" class="form-control" id="ad" name="ad" required>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="miktar" class="form-label">Miktar</label>
                            <input type="number" class="form-control" id="miktar" name="miktar" required min="0" value="0">
                        </div>
                        <div class="col-md-6">
                            <label for="fiyat" class="form-label">Fiyat (TL)</label>
                            <input type="number" class="form-control" id="fiyat" name="fiyat" required min="0" step="0.01" value="0.00">
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="resim" class="form-label">Ürün Fotoğrafı</label>
                        <input type="file" class="form-control" id="resim" name="resim" accept="image/*">
                        <div id="resim-onizleme" class="text-center"></div>
                    </div>

                    <div class="text-end">
                        <a href="{{ url_for('urun_listesi') }}" class="btn btn-secondary me-2">
                            <i class="fas fa-times me-1"></i>İptal
                        </a>
                        <button type="submit" class="btn btn-success">
                            <i class="fas fa-save me-1"></i>Kaydet
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Resim önizleme
    document.getElementById('resim').addEventListener('change', function(e) {
        const file = e.target.files[0];
        const preview = document.getElementById('resim-onizleme');
        
        if (file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                preview.innerHTML = `<img src="${e.target.result}" class="preview-image">`;
            }
            reader.readAsDataURL(file);
        } else {
            preview.innerHTML = '';
        }
    });

    // Barkod tarama
    let stream = null;
    const videoElement = document.getElementById('video-preview');
    const barkodTaraBtn = document.getElementById('barkod-tara');
    const kameraAlani = document.getElementById('kamera-alani');
    const barkodInput = document.getElementById('barkod');

    barkodTaraBtn.addEventListener('click', async () => {
        try {
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
                stream = null;
                videoElement.style.display = 'none';
                barkodTaraBtn.innerHTML = '<i class="fas fa-barcode me-1"></i>Barkod Tara';
                return;
            }

            // Mobil cihaz kontrolü
            const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
            
            const constraints = {
                video: {
                    facingMode: isMobile ? "environment" : "user",
                    width: { min: 640, ideal: 1280, max: 1920 },
                    height: { min: 480, ideal: 720, max: 1080 },
                    focusMode: "continuous",
                    exposureMode: "continuous",
                    whiteBalanceMode: "continuous"
                }
            };

            try {
                stream = await navigator.mediaDevices.getUserMedia(constraints)
                    .catch(async () => {
                        // Arka kamera kullanılamıyorsa, herhangi bir kamerayı dene
                        return await navigator.mediaDevices.getUserMedia({
                            video: true
                        });
                    });

                videoElement.srcObject = stream;
                await videoElement.play();
                videoElement.style.display = 'block';
                barkodTaraBtn.innerHTML = '<i class="fas fa-times me-1"></i>Kamerayı Kapat';

                // Her 500ms'de bir barkod tarama
                const interval = setInterval(async () => {
                    if (!stream) {
                        clearInterval(interval);
                        return;
                    }

                    try {
                        const canvas = document.createElement('canvas');
                        canvas.width = videoElement.videoWidth;
                        canvas.height = videoElement.videoHeight;
                        const context = canvas.getContext('2d');
                        context.drawImage(videoElement, 0, 0, canvas.width, canvas.height);

                        canvas.toBlob(async (blob) => {
                            const formData = new FormData();
                            formData.append('image', blob);

                            try {
                                const response = await fetch('/barkod/tara', {
                                    method: 'POST',
                                    body: formData
                                });

                                if (response.ok) {
                                    const data = await response.json();
                                    if (data.barkod) {
                                        barkodInput.value = data.barkod;
                                        
                                        stream.getTracks().forEach(track => track.stop());
                                        stream = null;
                                        videoElement.style.display = 'none';
                                        barkodTaraBtn.innerHTML = '<i class="fas fa-barcode me-1"></i>Barkod Tara';
                                        clearInterval(interval);
                                    }
                                }
                            } catch (error) {
                                console.error('Barkod tarama hatası:', error);
                            }
                        }, 'image/jpeg', 0.7);

                    } catch (error) {
                        console.error('Canvas hatası:', error);
                    }
                }, 500);

            } catch (error) {
                console.error('Kamera hatası:', error);
                if (error.name === 'NotAllowedError' || error.name === 'PermissionDeniedError') {
                    alert('Kamera izni verilmedi. Lütfen kamera izni verin ve tekrar deneyin.');
                } else if (error.name === 'NotFoundError' || error.name === 'DevicesNotFoundError') {
                    alert('Kamera bulunamadı. Lütfen cihazınızda bir kamera olduğundan emin olun.');
                } else if (error.name === 'NotReadableError' || error.name === 'TrackStartError') {
                    alert('Kamera başlatılamadı. Lütfen başka bir uygulamanın kamerayı kullanmadığından emin olun.');
                } else {
                    alert('Kamera başlatılırken bir hata oluştu: ' + error.message);
                }
            }
        } catch (error) {
            console.error('Genel hata:', error);
            alert('Bir hata oluştu: ' + error.message);
        }
    });
</script>
{% endblock %} 